#!/usr/bin/env php
<?php

echo <<<EOF
Database script management.


EOF;

array_shift($argv);
if (!isset($argv[0])) {
    exit(<<<EOF
Specify a command to run:

install: initialize database
load-fixtures: load fixtures

EOF
    );
}

// Extract command from argument list
$command = array_shift($argv);

// Check that command is available
if (!is_callable($command))
{
    exit(sprintf("Command \"%s\" does not exist.\n", $command));
}

// Bootstrap application
$app = require_once __DIR__ . '/../app/bootstrap.php';

echo ">> $command\n";

// Execute command
if( $command($app, $argv) )
{
	echo "Success\n";
}
else
{
	echo "Error\n";
}




/**
 *	Database installation
 *
 * 	@author 	Mikael Randy <mikael.randy@gmail.com>
 *	@version 	1.0 - 23 mars 2012 - Mikael Randy <mikael.randy@gmail.com>
 */
function install($app, $a_argument)
{
	$driver = $app['db']->getDriver()->getName();
	switch ($driver)
	{
		case 'pdo_sqlite':
			// Create database file
			if (!is_dir($databaseDir)) 
			{
			    mkdir($databaseDir, 0777, true);
			}
			$file = __DIR__ . '/../data/sql/schema.sqlite3.sql';
			break;

		case 'pdo_mysql':
			$file = __DIR__ . '/../data/sql/schema.mysql.sql';
			break;

		default:
			printf("Driver \"%s\" is not supported.\n", $driver);
			return false;
	}

	$aSQL = explode(';', file_get_contents($file));
	foreach ($aSQL as $sql) 
	{
		$sql = trim($sql);
		if ($sql)
		{
			$app['db']->query($sql);
		}
	}

	return true;
}

/**
 *	Fixtures loading
 *
 * 	@author 	Mikael Randy <mikael.randy@gmail.com>
 * 	@version 	1.0 - 23 mars 2012 - Mikael Randy <mikael.randy@gmail.com>
 */
function fixtures($app, $a_argument)
{	
	$file = __DIR__.'/../data/sql/fixtures.sql';

	$aSQL = explode(';', file_get_contents($file));
	foreach ($aSQL as $sql) 
	{
		$sql = trim($sql);
		if ($sql)
		{
			$app['db']->query($sql);
		}
	}

	return true;
}

/**
 *	Execute all database commands
 *
 * 	@author 	Mikael Randy <mikael.randy@gmail.com>
 * 	@version 	1.0 - 23 mars 2012 - Mikael Randy <mikael.randy@gmail.com>
 */
function all($app, $a_argument)
{
	$result = false;

	// If install succeed, try to load fixtures
	if( install($app, $a_argument) )
	{
		$result = fixtures($app, $a_argument);
	}

	return $result;
}
